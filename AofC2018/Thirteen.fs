module Thirteen

type Direction = | N | S | E | W

type Turn = | Left | Right | Ahead

type Point = (int*int)

type Orientation = | NS | EW

type Curvature = | SWtoNE | NWtoSE

type TrackType = | Straight of Orientation | Curve of Curvature | Intersection

type TrackSegment = { p:Point; t:TrackType }

type CartState = { p:Point; d:Direction; step:int }

type Cart = {no:int; state:CartState}

type GridCell = | Track of TrackSegment | Empty

let movePoint (p:Point) (d:Direction) = 
    let (x,y) = p
    match d with
    | N -> (x,y-1)
    | S -> (x,y+1)
    | W -> (x-1,y)
    | E -> (x+1,y)

let turn (d:Direction) (t:Turn) = 
    match t with
    | Left  -> match d with | N -> W | S -> E | E -> N | W -> S
    | Right -> match d with | N -> E | S -> W | E -> S | W -> N
    | Ahead -> d

let handleCurve (c:Curvature) (state:CartState) =
    let d' =
        let d = state.d
        match c with
        | SWtoNE -> match d with | S -> W | N -> E | W -> S | E -> N
        | NWtoSE -> match d with | S -> E | N -> W | W -> N | E -> S
    {state with d = d'}

type Grid (N:int, M:int) = 
    let array = Array2D.create N M  Empty

    member __.Item
        with get (p:Point) = array.[snd p, fst p]
        and  set (p:Point) (value: GridCell) = array.[snd p, fst p] <- value

    member this.Populate (l:seq<TrackSegment>) =
        l |> Seq.iter (fun l -> this.[l.p] <- Track l)   
        
let getCellTrackSegment (g:Grid) (p:Point) =
    match g.[p] with
    | Track ts -> ts.t
    | Empty    -> failwith "Not on track"

let handleIntersection (rules:Turn array) (state:CartState) =    
    let d' = turn state.d rules.[state.step]
    {state with d = d'; step = (state.step + 1) % rules.Length}

let move (rules:Turn array) (g:Grid) (c:Cart) =
    let p' = c.state.d |> movePoint c.state.p
    let ts = p' |> getCellTrackSegment g
    let state' = {c.state with p=p'}
    let state'' = 
        match ts with
        | Curve t      -> handleCurve t state'
        | Intersection -> handleIntersection rules state'
        | _            -> state'
    {c with state = state''}

let collides (p:Point) (carts:Cart list) =
    carts |> List.exists (fun c -> c.state.p = p)

let collideAndRemove (p:Point) (carts:Cart list) =
    if collides p carts then
        (true, carts |> List.filter (fun c -> c.state.p <> p))
    else
        (false, carts)

let moveCarts (rules:Turn array) (g:Grid) (carts:Cart list) =
    let rec loop (point:Point option) (acc:Cart list) (carts':Cart list) =
        match point with
        | Some p -> (Some p, acc)
        | None ->
            match carts' with
            | []   -> (None, acc)
            | h::t -> 
                let h' = move rules g h
                let collision = (acc |> collides h'.state.p) || (carts' |> collides h'.state.p)
                loop (if collision then Some h'.state.p else None) (h'::acc) t            
    loop None [] (carts |> List.sortBy (fun c -> snd c.state.p, fst c.state.p))  
    
let moveRemoveCarts (rules:Turn array) (g:Grid) (carts:Cart list) =
    let rec loop (acc:Cart list) (carts':Cart list) = 
        match carts' with
        | [] -> acc
        | h::t -> 
            let h' = move rules g h
            let (cP, acc') = acc |> collideAndRemove h'.state.p
            if cP then loop acc' t
            else
                let (cN, t') = t |> collideAndRemove h'.state.p
                if cN then loop acc t' else loop (h'::acc) t        
    loop [] (carts |> List.sortBy (fun c -> snd c.state.p, fst c.state.p)) 

let runSim (rules:Turn array) (g:Grid) (carts:Cart list) =
    let rec loop (tick:int) (crash:Point option, carts':Cart list) =        
        match crash with
        | Some p -> p
        | None   -> loop (tick + 1) (moveCarts rules g carts')
    loop 0 (None, carts)

let runSimToLast (rules:Turn array) (g:Grid) (carts:Cart list) =
    let rec loop (tick:int) (carts':Cart list) =        
        match carts' with
        | [last] -> last.state.p
        | []     -> failwith "All carts destroyed"
        | _      -> loop (tick + 1) (moveRemoveCarts rules g carts')
    loop 0 carts

let private toTrackParts (p:Point) (c:char) (step:int) = 
    let (c',cart) = 
        match c with
        | '<' -> ('-', Some {p=p; d=W; step=step})
        | '>' -> ('-', Some {p=p; d=E; step=step})
        | '^' -> ('|', Some {p=p; d=N; step=step})
        | 'v' -> ('|', Some {p=p; d=S; step=step})
        |  _  -> (c, None)
    match c' with
    | '-' -> (Some {p=p; t=Straight EW}, cart)
    | '|' -> (Some {p=p; t=Straight NS}, cart)
    | '/' -> (Some {p=p; t=Curve SWtoNE}, None)
    | '\\'-> (Some {p=p; t=Curve NWtoSE}, None)
    | '+' -> (Some {p=p; t=Intersection}, None)
    |  _  -> (None, None)

let private lineToTrackParts (y:int) (l:string) (init:int) =
    l.ToCharArray() 
    |> Array.toSeq 
    |> Seq.mapi (fun x c -> toTrackParts (x,y) c init)

let execute = fun d ->
    let lines = d |> Parsing.splitLines
    let parts = lines |> Seq.mapi (fun i l -> lineToTrackParts i l 0) |> Seq.concat
    let tracks = parts |> Seq.choose (fst) |> List.ofSeq
    let carts = parts |> Seq.choose (snd) |> Seq.mapi (fun i s -> {no=i;state=s}) |> List.ofSeq
    let maxX = tracks |> List.maxBy (fun t -> fst t.p)
    let maxY = tracks |> List.maxBy (fun t -> snd t.p)
    let g = Grid ((snd maxY.p) + 1, (fst maxX.p) + 1)
    tracks |> g.Populate    
    let rules = [|Left;Ahead;Right|]
    let (x,y) = runSim rules g carts
    printfn "Day 13 - part 1: Crash at %i,%i" x y
    let (x,y) = runSimToLast rules g carts
    printfn "Day 13 - part 2: Last at %i,%i" x y

let testSet = @"
/->-\        
|   |  /----\
| /-+--+-\  |
| | |  | v  |
\-+-/  \-+--/
  \------/   
"

let dataSet = @"
                           /-------------------------------------------------------------------------------------------------\                        
 /-------------------------+--\/---------------------------------------------------------------------------------------------+----------\             
 |                       /-+--++---------------------------------------------------------------------------------------------+------\   |             
 |                /------+-+--++-------------------------------------------------------------------------<-\                 |      |   |             
 |           /----+------+-+--++----------------\                                                          |                 |      |   |             
 |           |    |      | |  ||                |                   /----------------\                     |                 |      |   |             
 |           |    |      | | /++---------\      |                   |                |                     |        /--------+------+---+-----------\ 
 |           |   /+------+-+-+++---------+------+-------------------+-------\   /----+---------------------+--------+--------+------+--\|           | 
 |           |   ||      | | |||         |      |  /----------------+-------+---+----+---------------------+\       |        |      |  ||           | 
 | /---------+\  ||      | | |||         |      |  |       /--------+-------+---+----+---------------------++-------+--------+------+--++--------\  | 
 | |         ||  ||      | | |||         |      |  |       | /------+-\     |   |    |                     ||       |   /----+------+--++------\ |  | 
 | |         ||  ||      | | ||| /-------+---\  |  |       | |      | |     |   |    |                     ||       |   |    |      |  ||      | |  | 
 | |         ||  ||   /--+-+-+++-+--\    |   |  |  |       | |      | |     |   |    |          /----------++-------+---+----+------+--++------+-+-\| 
 | |         ||  ||   |  | | ||| |  |    |   |  |  |       | |      | |     |  /+----+----------+----------++-------+---+----+------+--++------+-+\|| 
 | |         \+--++---+--+-+-+++-+--+----+---+--/  |       | |      | |     |  ||    |          |          ||       |   |    |      |  ||      | |||| 
 | |          |  ||   |  | | ||| |  |    |   |     |       | |      | |     |  ||    |          |          ||      /+---+----+------+--++-----\| |||| 
 | |          |  ||   |  | | ||| |/-+----+---+-----+-------+-+------+-+-----+--++----+----------+----------++------++---+----+---\  |  ||     || |||| 
/+-+----------+--++---+--+-+-+++-++-+----+---+-----+-------+-+------+-+-----+--++----+---------\|          ||      ||   |    | /-+--+--++---\ || |||| 
|| |          |  ||   |  | | ||| || |/---+---+-----+-------+-+------+-+-----+--++----+---------++----------++------++-\ |    | | |  |  ||   | || |||| 
|| |         /+--++---+--+-+-+++-++-++---+---+-----+\      | |      | |     |  ||    |         ||          ||      || | |    | | |  |  ||   | || |||| 
|| |         || /++---+--+-+-+++-++-++---+---+-----++------+-+------+-+-----+--++----+--\      ||          ||      || | |    | | |  |  ||   | || |||| 
|| |  /------++-+++---+--+\| \++-++-++---/   |     ||      | |   /--+-+-----+--++----+--+------++---------\||      || | \----+-+-+--+--++---+-+/ |||| 
|| |  |      || |||   |  ||\--++-++-++-------+-----++------+-+---+--+-+-----+--++----+--+------++-------->+++------++-+------/ | |  |  ||   | |  |||| 
|| |  |      || |||   |  ||   || || ||       |     ||      | |   |  | |     |  || /--+--+------++---------+++------++-+--------+-+--+--++\  | |  |||| 
|| |  |      || |||   |  \+---++-++-++-------+-----++------+-+---+--+-+-----+--++-+--+--+------++---------+++------++-+--------+-+--/  |||  | |  |||| 
|| |  |      || |||   | /-+---++-++-++-------+-----++------+-+---+--+-+-----+--++-+--+--+------++---------+++------++-+\       |/+-----+++--+-+--++++\
|| \--+------+/ |||   | | |   || || ||       |     ||      | |   |  | |     |  || |  |  |      ||         |||      || ||       |||     |||  | |  |||||
||    |      |  ||| /-+-+-+---++-++-++-------+-----++------+-+---+--+-+-----+--++-+--+\ |      ||         |||      ||/++-------+++-----+++--+-+-\|||||
||    |      |  ||| | | | |   || || ||       | /---++------+-+---+--+-+-----+--++-+\ || |      ||   /-----+++------+++++---\   |||     |||  | | ||||||
||    |    /-+--+++-+-+-+-+---++-++-++-------+-+---++------+-+---+--+-+-----+--++-++-++-+------++---+----\|||      |||||   |   |||     |||  | | ||||||
||/---+----+-+--+++-+-+-+-+---++-++-++-------+-+---++---\  | |   |  \-+-----+--++-++-/| |      ||   |    ||||      |||||   |   |||     |||  | | ||||||
|||   |    | |  ||| | | | |   || || ||       | |   ||   |  | |   |    |     |  || ||  | |      ||   |    ||||      |||||   |   |||     |||  | | ||||||
|||   |    | |  ||| | | | |/--++-++-++-------+-+---++---+--+-+---+----+-----+--++-++--+-+------++---+----++++\     |||||   |   |||     |||  | | ||||||
|||   |    | |  ||| | | | ||  || || ||       | |/--++---+--+-+---+----+-----+--++-++--+-+------++---+----+++++-----+++++-\ |   |||     |||  | | ||||||
|||   |    | |  ||| |/+-+-++--++-++-++-------+-++--++---+--+-+---+----+-----+--++-++--+-+------++---+----+++++-----+++++-+\|   |||     |||  | | ||||||
|||   |    | |  ||| ||| | ||  || || ||       | ||  ||   |  |/+---+----+--\  |  || ||  | |      ||   |    |||||    /+++++-+++-\ |||     |||  | | ||||||
|||   |    | |  ||| ||| | ||  || \+-++-------/ ||  ||   |  |||   |    |  |  |  \+-++--+-+------++---+----+++++----++++++-+++-+-+++-----+++--+-+-++/|||
|||   |   /+-+--+++-+++-+-++--++--+-++---------++--++---+--+++--\|    |  |  |   | ||  | |      ||   | /--+++++----++++++-+++-+-+++--\  |||  | | || |||
|||   |   || |  ||| ||| | ||  || /+-++---------++--++---+--+++--++----+--+--+---+-++--+-+------++---+-+--+++++-\  |||||| ||| | |||  |  |||  | | || |||
|||   |   || |  ||| ||| \-++--++-++-++---------++--++---+--+++--++----+--+--+---+-++--+-+------++---+-+--+++++-+--+++++/ ||| | |||  |  |||  | | || |||
|||   |   || |  ||| |||   ||  || || ||  /------++--++---+--+++--++----+--+--+---+-++--+-+-<----++---+-+--+++++\|  |||||  ||| | |||  |  |||  | | || |||
|||   |   || |  ||| |||   ||  || || ||  |/-----++--++---+--+++--++----+--+--+---+-++--+-+\     ||   | |  |||||||  |||||  ||| | |||  |  |||  | | || |||
|||   |   || |  ||| |||   |^  || || ||  ||     |\--++---+--+++--++----+--+--+---+-++--+-++-----++---+-+--+++++++--+++++--/|| | |||  |  |||  | | || |||
|||   |   || |  ||| |||/--++--++-++-++--++-----+---++---+--+++--++----+--+--+---+\||  | ||     ||   | |  |||||||  |||||   || | |\+--+--+++--+-+-++-++/
|||   |   || |  ||| ||||/-++--++-++-++--++-----+---++---+--+++--++----+--+--+-\ ||||  | ||     ||   \-+--+++++++--+++++---+/ | | |  |  |||  | | || || 
|||   |   ||/+--+++-+++++-++--++-++-++--++----\|   ||   |  |||  ||    |  |  | | ||||  | ||     ||   /-+--+++++++--+++++---+--+-+-+--+--+++\ | | || || 
||\---+---++++--+++-+++++-++--++-++-++--++----++---++---/  |||  ||    |  |  | | ||||  | ||     ||   | |  |||||||  |||\+---+--+-+-+<-+--++++-+-+-/| || 
||    |   ||||  ||| ||||| ||  || ||/++--++----++---++------+++--++----+--+--+-+-++++--+-++-----++---+-+-\|||||||  ||| |   |  | | |  |  |||| | |  | || 
||    |   ||||  ||| ||||| ||  || |||||  ||    ||   ||      |||  ||    |  |  | | ||\+--+-++-----++---+-+-++++++++--+++-+---+--+-+-+--+--++/| | |  | || 
||   /+---++++--+++-+++++-++--++\|||||  || /--++---++------+++--++----+--+--+-+-++-+--+-++-----++---+-+-++++++++--+++-+---+--+-+-+--+--++-+-+-+--+-++\
||   ||   ||||  ||| ||||| ||  |||||||| /++-+--++---++------+++--++----+--+--+-+-++-+--+-++-----++---+-+-++++++++--+++-+---+--+-+-+--+-\|| | | |  | |||
||   ||   ||||  ||| \++++-++--++++++++-+++-+--++---++------+++--++----+--+--+-+-++-+--/ ||     |\---+-+-++++++++--+++-+---+--+-+-+--+-+++-+-+-+--+-/||
||   ||   ||||  |||/-++++-++--++++++++-+++-+--++---++------+++--++----+--+--+-+-++-+----++-\   |    | | ||||||||  ||| |   |  | | |  | ||| | | |  |  ||
||   ||   ||||  |||| \+++-++--++++++++-+++-+--++---++------+++--++----+--+--+-+-++-+----++-+---+----+-+-++++++++--+++-+---/  | | |  | ||| | | |  |  ||
||   ||   ||||  ||||  ||| ||  |||||||| |||/+--++---++------+++--++----+--+\ | | || |    || |   |    | | ||||||||  ||| |      | | |  | ||| | | |  |  ||
||   ||   ||||  ||||  ||| ||  |||||||| |||||  ||  /++------+++--++----+--++-+-+-++-+\   || |   |    | | ||||||||  ||| |      | | |  |/+++-+-+-+-\|  ||
||   || /-++++--++++--+++-++--++++++++-+++++--++--+++------+++--++----+--++-+-+-++-++---++-+---+----+-+-++++++++-\||| |      | | |  ||||| | | | ||  ||
|| /-++-+-++++--++++--+++-++--++++++++-+++++--++--+++------+++--++----+-\|| | | || ||   || |   |    | | |||||||| |||| |      | | |  ||||| | | | ||  ||
|| | || | ||||  ||||  ||| ||  |||||||| |||||  ||  |||      |||  ||    | ||| | | || ||   || |   |    | | |||||||| |||| |      | | |  ||||| | | | ||  ||
|| | || | ||||  ||||  ||| ||  |||||||| |||||  || /+++------+++--++----+-+++-+-+-++-++---++-+---+----+-+-++++++++\|||| |      | | |  ||||| | | | ||  ||
|| | || | |||\--++++--+++-++--++++++++-+++++--++-+++/      |||/-++----+-+++-+-+-++-++---++-+---+----+-+\||||||||||||| |      | | |  ||||| | | | ||  ||
|| | || | |||   |||| /+++-++--++++++++-+++++--++\|||       |||| ||    | ||| | | || ||   || |   |    | ||||||||||||||| |      | | |  ||||| | | | ||  ||
||/+-++-+-+++---++++-++++-++--++++++++-+++++--++++++-------++++-++----+-+++\| | || ||   || |   |    | ||||||||||||||| |      | \-+--+++++-+-/ | ||  ||
|||| || | |||   |||| |||| ||  |||||||| |||||  ||||||       |||| ||/---+-+++++-+-++-++---++-+---+-\  | ||||||||||||||| |      |   |  ||||| |   | ||  ||
|||| || | |||   |||| |||| ||  |||||||| |||||  ||||||       ||\+-+++---/ ||||| | || ||   || |   | |  | ||||||||||||||| |      |   |  ||||| |   | ||  ||
|||| || | |||   |||| |||| ||  |||||||| |||||  ||||||       || | |||     ||||| | || ||   || |   | |  | ||||||||||||||| |      |   |  ||||| |   | ||  ||
|||| || | ||\---++++-++++-++--++++++++-+++++--/|||||       || | |||  /--+++++-+-++-++---++-+---+-+--+-+++++++++++++++-+------+--\|  ||||| |   | ||  ||
|||| || \-++----++++-++++-++--++++++++-+++++---+++++-------++-+-+++--+--+++++-+-++>++---++-+---+-+>-+-+++++++++++/||| |      |  ||  ||||| |   | ||  ||
||||/++---++---\||\+-++++-++--++++++++-+++++---+++++-------++-+-+++--+--+++++-+-++-++---++-+---+-+--+-+++++/||||| ||| |      |  ||  ||||| |   | ||  ||
|||||||   ||   ||| | |||\-++--++++++++-+++++---+++++-------++-+-+++--+--+++++-/ || ||   ||/+---+-+-\| ||||| ||||| ||| |   /--+--++--+++++-+---+-++-\||
|||||||  /++---+++-+-+++-\||  |||||||| |||||   |||||       || | |||  |  |||||   || ||   ||||   | | || ||||| ||||| ||| |   |  |  ||  ||||| |   | || |||
|||||||  |||   ||| | ||| |||  |||||||| |||||   |||||       || | ||v  |  |||||   || ||   ||||   | | || ||||| ||||| ||| |   |  |  ||  ||||| |   | || |||
|||||||  |||   ||| | ||| |||  |||||||| |||||   |||||     /-++-+-+++--+--+++++---++-++---++++---+-+-++-+++++-+++++-+++-+-\ |  |  ||  ||||| |   | || |||
|||||||  |||   ||| | ||| |||  |||||||| ||\++---+++++-----+-++-+-+++--+--+++++---++-++---+/||   | | || ||||| ||||| ||| | | |  |  ||  ||||| |   | || |||
|||||||  ||| /-+++-+-+++-+++--++++++++-++-++---+++++-\   | || | |\+--+--+++++---++-++---+-++---+-+-++-++++/ ||||| ||| | | |  |  ||  ||||| |   | || |||
|||||||  ||| | ||| | ||| ||| /++++++++-++-++---+++++-+---+-++-+\| |  |  |||||   || ||   | ||   | | || ||||  ||||| ||| | | |  |  || /+++++-+--\| || |||
|||||||  ||| | ||| | ||| ||| ||||||||| || ||   ||||| |/--+-++-+++-+--+--+++++---++-++-\ | ||   | | || ||||  ||||| ||| | | |  |  || |||||| |  || || |||
|||||||  ||| | ||| | ||| ||| ||||||||| || ||   ||||| ||  | || ||| |  |  |||||   || || | | ||   | | || ||||  ||||| ||| | | |  |  || |||||| |  || || |||
|||||||  ||| | ||| | ||| ||| ||||||||| || ||   ||||| ||  | || ||| |  |  |||||   || || | | \+---+-+-/| ||||  ||||| ||| | | |  |  || |||||| |  || || |||
|||||||  ||| | ||| | ||| ||| |||||\+++-++-++---+++++-++--+-++-+++-+--+--+++++---++-++-+-+--+---+-+--+-++++--+++++-+++-+-+-+--+--+/ |||||| |  || || |||
|||||||  ||| | ||| | ||| |||/+++++-+++-++-++---+++++-++--+-++-+++-+--+--+++++---++-++-+-+--+---+-+--+-++++--+++++-+++-+-+-+--+-\|  |||||| |  || || |||
|||||||  ||| | ||| | ||| ||||||||| |||/++-++---+++++-++--+-++-+++-+--+--+++++---++-++-+-+--+--\| |  | ||||  ||||| ||| | | |  | ||  |||||| |  || || |||
|||||||  ||| | ||| | ||| ||||||||| |||||| ||   ||||| ||  | || ||| |  |  |||||   || || | |  |  || |  | ||||  ||||| ||| | | |  | ||  |||||| |  || || |||
|||||||  ||| | ||| | ||| ||||||||| |||||| ||   ||||| ||  | || ||| |  |  |||||   || || | |  |  || |  | ||||  ||||| ||\-+-+-+--+-++--++++++-+--++-++-+/|
|||||||  ||| | ||| | ||| ||||||||| |||||| ||   ||||| ||  | || ||| |/-+--+++++---++-++-+-+--+--++-+--+-++++--+++++-++--+-+-+--+-++--++++++-+\ || || | |
|||||||  ||| | ||| | |\+-+++++++++-+/|||| ||   ||||| ||  | || ||| || |  |||||   || || | |  |  || |  | ||||  ||||| ||  | | |  | ||  \+++++-++-/| || | |
|||||||  ||| | ||| | | | ||||||||| | |||| ||   ||||| |\--+-++-+++-++-+--+++++---++-++-/ |  |  || |  | ||||  ||||| |\--+-+-+--+-++---+++++-++--/ || | |
|||||||  ||| | ||| | | | ||||||||| | ||\+-++---+++++-+---+-++-+++-++-+--+++++---++-++---+--+--++-+--+-++++--+++++-+---+-+-+--+-++---++/|| ||    || | |
|\+++++--+++-+-+++-+-+-+-+++++/||| | || | ||   ||||| |   | || ||| || |/-+++++---++-++---+--+--++\|  | ||||  ||||| |   | | |  | ||   || || ||    || | |
| |||||  ||| | ||| | | | ||||| ||| | || | ||   ||||| |   | || ||| || || |||||   || ||   |  |  ||||  | ||||  ||||| |   | | |  | ||   || || ||    || | |
| ||\++--+++-+-/|| | | | ||||| ||| | || | ||/--+++++-+---+-++-+++-++-++\|||||   || ||   |  |  ||||  | ||||  ||||| |   | | |  | ||   || || ||    || | |
| || ||  ||| |  || | | | ||||| ||| | || | |||  ||||\-+---+-++-+++-++-++++++++---++-++---+--+--++++--+-++++--/|||| |   | | |  | ||   || || ||    || | |
| || ||  ||| |  || | | | ||||| ||| |/++-+-+++--++++--+---+-++-+++-++-++++++++---++-++---+--+--++++-\| ||||   |||| |   | | |  | ||   || |v ||    || | |
| || ||  |||/+--++-+-+-+-+++++-+++-++++-+-+++--++++--+---+-++-+++-++-++++++++---++-++---+--+--++++\|| ||||   |||| |   | | |  | ||   || || ||    || | |
| || ||  |||||  || | | | ||||| ||| ||\+-+-+++--++++--+---+-++-+++-++-++++++++---++-++---+--+--+++++++-++++---++++-+---/ | |  | ||   v| || ||    || | |
| ||/++--+++++--++-+-+-+-+++++-+++-++-+-+-+++--++++--+---+-++-+++-++-++++++++---++-++--\|  |  ||||||| ||||   |||| |     | |  | ||   || || ||    || | |
| |||||  |||||  |\-+-+-+-+++++-+++-++-+-+-+++--++++--+---+-++-+++-++-+++++++/   || ||  ||  |  ||||||| ||||   |||| |     | |  | ||   || || ||    || | |
| |||||  |||||  |  | | | ||||| ||| || | | |||  ||||  |   | || ||| || |||||||  /-++-++--++--+-\||||||| ||||   |||| |     | |  | ||   || || ||    || | |
| |||||  |||||  |/-+-+-+-+++++-+++-++-+-+\|||  ||||  |   | || \++-++-+++++++--+-++-++--++--+-++++++++-+/||   |||| \-----+-+--/ ||   || || ||    || | |
| |||||  |||||  || | | | |v||| ||| || | |||||  ||||/-+---+-++--++-++-+++++++--+-++-++--++--+-++++++++-+-++---++++-------+-+----++---++-++-++----++-+\|
| |||||  |||||  || | | | ||||| ||| || | |||||  ||||| |   | ||  || || |||||||  | || ||  ||  | |^||||||/+-++---++++------\| |    ||   || || ||    || |||
| |||||  |||||  || | | | ||||\-+++-++-+-+++++--+++++-+---+-++--/| || |||||||  | || ||  ||  | |||||||||| ||   ||||      || |    ||   || || ||    || |||
| |||||  |||||  || | | | ||||  \++-++-+-+++++--+++++-+---+-++---+-++-+++++++--+-++-++--++--+-++++++++++-++---++++------++-+----++---++-+/ ||    || |||
| |||||  |||||  || | | | ||||   || || | |||||  ||||| |   | ||   | |\-+++++++--+-++-++--++--+-++++++++++-++---++++------++-+----++---++-+--+/    || |||
| |||||  |||||/-++-+-+-+-++++---++-++-+-+++++--+++++-+---+-++---+-+>-+++++++--+-++-++--++--+-++++++++++-++---++++----\ || |    ||   || |  |     || |||
| |||||  |||||| || | | | ||||   || || | |||||  ||||| |   | ||   | |  |||||||  | |^ ||  ||  | |||||||||| ||   ||||    | || |   /++-<-++-+--+---\ || |||
| |||||  |||||| || | | | ||||   || || \-+++++--+++++-+---+-++---+-+--+++++++--+-++-++--++--+-+/|||||||| ||   ||||    | || |   |||   || |  |   | || |||
| |||||  |||||| || | | | ||\+---++-++---+++++--+++++-+---+-++---+-+--+++++++--+-++-++--++--+-+-++++++++-++---/|||    | || |   |||   || |  |   | || |||
| ||||\--++++++-++-+-+-+-+/ |   || ||   |||||  ||||| |   | ||   | |  |||||||  | || ||  ||  | | |||||||| ||    |||    | || |   |||   || |  |   | || |||
| ||||   |||||| || | | \-+--+---++-++---+++++--+++++-+---+-++---+-+--+++++++--+-+/ ||  ||  | | |||||||| ||    |||    | || \---+++---++-+--+---+-++-/||
| ||||   |||||| || | |   |  |   || ||   \++++--+++++-+---+-++---+-+--+++++++--+-+--++--++--+-+-++++++++-++----/||    | ||     |||   || |  |   | ||  ||
| ||||   |||||| |\-+-+---+--+---++-++----/||\--+++++-+---+-++---+-+--++/||||  | |  ||  ||  | | |||||||| ||     ||/---+-++-\   |||   || |  |   | ||  ||
| ||||   |||||| |  | |   |  |   || ||     ||   ||||| |   | \+---+-+--++-++++--+-+--++--++--+-+-++++++++-++-----+++---+-++-+---+++---++-+--+---+-+/  ||
| ||\+---++++++-+--+-+---+--+---++-++-----++---+++++-+---+--+---+-+--++-++++--+-+--++--/|  | | |||||||| ||     |||   | || |   |||   || |  |   | |   ||
| || |   |||||| |  | |   |  |   || ||     ||   ||||| |   |  |   | |  || ||||  | \--++---+--+-+-++++++++-++-----+++---+-++-+---+++---++-/  |   | |   ||
| || |   |||||| |  | |   |  |   || ||     ||   ||||| |   |  |   | |  || ||||  |    ||   |  | | |||||||| ||     |||   | || |   |||   ||/---+---+-+-\ ||
| || |   \+++++-+--+-+---/  |   || ||     ||   ||||\-+---+--+---+-+--++-++++--+----++---+--+-+-++++++++-++-----+++---+-++-+---+++---+++---+---+-+-+-/|
| \+-+----+++++-+--+-+------+---++-++-----++---++++--+---+--+---+-+--++-+++/  |    ||/--+--+-+-++++++++-++-----+++---+-++-+\  |||   |||   |   | | |  |
|  | |    ||||| |  | |      |   || ||     ||   ||||  |   |  |   | |  || |||   |    |||  |  | | |||||||| ||     |||   | || ||  ||| /-+++---+\  | | |  |
|  | |    ||||| |  | |  /---+---++-++-----++---++++\ |   |  |   | |  || |||   |    |||  |  | | |||||||| ||     |||   | || ||  ||| | |||   ||  | | |  |
|  | |    ||||| |  | |  |   |   || ||     ||   \++++-+---+--+---+-+--++-+++---+----/||  |  | | |||||||| ||     |||   | || ||  ||| | |||   ||  | | |  |
\--+-+----+++++-+--+-+--+---+---++-++-----++----++++-+---+--+---+-+--++-+++---+-----++--+--+-+-/||||\++-++-----+++---+-++-++--+++-+-+++---/|  | | |  |
   | |    ||\++-+--+-+--+---+---++-++-----++----++++-+---+--+---+-+--++-+++---+-----++--+--+-+--++/| || ||     |||   | || ||  ||| | |||    |  | | |  |
   | |    |\-++-+--+-+--+---+---++-++-----++----++++-+---+--+---+-+--++-+++---+-----++--+--+-+--++-+-++-+/     |||   | || ||  ||| | |||    |  | | |  |
   | |    |  || |  | |  |   |   |\-++-----++----++++-+---+--+---+-+--++-+++---+-----++--+--+-+--++-+-++-+------/||   | || ||  ||| | |||    |  | | |  |
   | |    |  || |  | |  |   |   |  ||     ||    |||| |   |  |   | |/-++-+++---+-----++--+--+-+--++-+-++>+-------++---+-++-++--+++-+\|||    |  | | |  |
   | |    |  || \--+-+--+---+---+--++-----++----++++-+---+--+---+-++-++-+++---+-----++--/  | |  || | || |       ||   |/++-++--+++-+++++----+--+-+\|  |
   | |    |  ||    | |  |   |   |  ||     ||    |\++-+---+--+---+-++-++-+++---+-----++-----+-+--++-+-++-+-------/|   |||| ||  ||| |||||    |  | |||  |
   \-+----+--++----+-+--+---+---+--++-----++----+-++-+---+--+---+-++-++-/||   |     ||     | |  || | || |        |   |||| ||  ||| |||||    |  | |||  |
     |    |  ||    | |  |   |   |  ||     ||    | || |   |  |   | \+-++--++---+-----++-----+-+--+/ | || |        |   |||| ||  ||| |||||    |  | |||  |
     |    |  ||    | |  |   |   |  \+-----++----+-++-+---+--+---+--+-++--++---+-----++-----+-+--+--+-++-//-------+---++++\||  ||| |||||    |  | |||  |
     |    |  ||  /-+-+--+---+---+---+\    ||    | || |   |  |   |  | |\--++---+-----++-----+-+--/  | ||  |       |   |||||||  ||| |||||    |  | |||  |
     |    \--++--+-+-+--+---+---+---++----++----+-++-+---+--+---/  | |   ||   |     ||     | |     | ||  |       |   |||||||  ||| |||\+----+--+-/||  |
     |       ||  | | |  |   |   |   ||    |\----+-++-+---+--+------+-+---++---+-----++-----+-+-----+-++--+-------+---+++++++--+++-+++-+----+--+--++--/
     |       ||  | | |  \---+---+---++----+-----+-+/ |   |  |      | |   ||   |     ||     | |     | ||  |       |   |||||||  ||| ||| |    |  |  ||   
     |       ||  | | |      |   |   ||    |     | |  |   |  |      | |   ||   |     |\-----+-+-----+-++--+-------+---++++++/  ||| ||| |    |  |  ||   
     |       ||  | | \------+---+---++----+-----/ |  |   |  |      \-+---++---+-----+------+-+-----+-++--+-------+---++++++---+++-+/| |    |  |  ||   
     |       ||  | |        |   |   ||    |       |  |   |  |        |   ||   \-----+------+-/     | |\--+-------+---++++++---+++-+-/ |    |  |  ||   
     |       \+--+-+--------+---+---++----+-------+--/   |  |        |   ||         |      |       | \---+-------+---++/|||   ||| |   |    |  |  ||   
     |        |  | \--------+---+---++----+-------+------+--+--------+---++---------+------/       |     |       |   || |||   ||| |   |    |  |  ||   
     |        |  |          |   |   ||    |       |      |  \--------+---/| /-------+--------------+-----+-------+\  |\-+++-<-+++-+---+----+--+--/|   
     |        |  |          |   |   ||    |       |      \-----------+----+-+-------+--------------+-----+-------++--+--/||   ||| |   |    |  |   |   
     |        |  |          |   |   \+----+-------+------------------+----+-+-------+--------------/     |       ||  |   ||   ||| |   |    |  |   |   
     |        |  |          |   |    |    |       |                  \----+-+-------+--------------------+-------++--+---++---++/ |   |    |  |   |   
     |        |  \----------+---+----/    |       \-----------------------+-+-------/                    |       \+--+---+/   \+--+---+----+--/   |   
     \--------+-------------+---/         |                               | |                            \--------+--+---/     |  \---+----/      |   
              |             \-------------+-------------------------------+-+-------------------------------------+--+---------/      |           |   
              \---------------------------+-------------------------------+-+-------------------------------------+--/                |           |   
                                          |                               | |                                     |                   \-----------/   
                                          \-------------------------------/ \-------------------------------------/                                   
"